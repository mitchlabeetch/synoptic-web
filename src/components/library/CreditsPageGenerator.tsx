// src/components/library/CreditsPageGenerator.tsx
// PURPOSE: Auto-generates Credits/Attribution page for ðŸŸ¡ Yellow sources
// ACTION: Creates a formatted credits page to insert into projects
// MECHANISM: Called when importing from attribution-required sources

'use client';

import { ProjectCredits, IngestedPage, IngestedLine } from '@/services/library/types';

interface CreditsSource {
  name: string;
  license: string;
  attributionText: string;
  url?: string;
}

/**
 * Generates a Credits page as an IngestedPage
 * This page is automatically appended to projects that use ðŸŸ¡ Attribution sources
 * 
 * @param sources - Array of sources requiring attribution
 * @param locale - User's locale for date formatting (defaults to 'en')
 */
export function generateCreditsPage(sources: CreditsSource[], locale: string = 'en'): IngestedPage {
  const lines: IngestedLine[] = [];
  
  // Header
  lines.push({
    id: 'credits-header',
    type: 'heading',
    L1: 'Credits & Attribution',
    L2: '',
  });
  
  // Separator
  lines.push({
    id: 'credits-sep-1',
    type: 'separator',
    L1: '',
    L2: '',
  });
  
  // Introduction
  lines.push({
    id: 'credits-intro',
    type: 'text',
    L1: 'This project uses content from the following sources, which require attribution:',
    L2: '',
  });
  
  // Each source
  sources.forEach((source, index) => {
    lines.push({
      id: `credits-source-${index}`,
      type: 'text',
      L1: `**${source.name}**\n${source.attributionText}\nLicense: ${source.license}${source.url ? `\nSource: ${source.url}` : ''}`,
      L2: '',
      meta: {
        sourceUrl: source.url,
      },
    });
  });
  
  // Separator
  lines.push({
    id: 'credits-sep-2',
    type: 'separator',
    L1: '',
    L2: '',
  });
  
  // Footer with locale-aware date formatting
  const formattedDate = new Intl.DateTimeFormat(locale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(new Date());
  
  lines.push({
    id: 'credits-footer',
    type: 'text',
    L1: `Credits generated by Synoptic on ${formattedDate}.`,
    L2: '',
  });
  
  return {
    id: 'credits-page',
    number: 999, // Always last
    title: 'Credits',
    lines,
  };
}

/**
 * Creates a ProjectCredits object for tracking attribution
 */
export function createProjectCredits(sources: CreditsSource[]): ProjectCredits {
  return {
    sources: sources.map(s => ({
      name: s.name,
      license: s.license,
      attributionText: s.attributionText,
      url: s.url,
    })),
    generatedAt: new Date().toISOString(),
  };
}

/**
 * Standard attribution templates for common sources
 */
export const ATTRIBUTION_TEMPLATES: Record<string, CreditsSource> = {
  tatoeba: {
    name: 'Tatoeba',
    license: 'CC-BY 2.0 FR',
    attributionText: 'Sentence examples provided by contributors at Tatoeba.org, released under Creative Commons Attribution 2.0 France.',
    url: 'https://tatoeba.org',
  },
  wiktionary: {
    name: 'Wiktionary',
    license: 'CC-BY-SA 3.0',
    attributionText: 'Definitions adapted from Wiktionary, the free dictionary, released under Creative Commons Attribution-ShareAlike.',
    url: 'https://en.wiktionary.org',
  },
  openfoodfacts: {
    name: 'Open Food Facts',
    license: 'ODbL',
    attributionText: 'Product data from Open Food Facts (openfoodfacts.org), released under the Open Database License.',
    url: 'https://openfoodfacts.org',
  },
  wikipedia: {
    name: 'Wikipedia',
    license: 'CC-BY-SA 3.0',
    attributionText: 'Content adapted from Wikipedia, released under Creative Commons Attribution-ShareAlike.',
    url: 'https://wikipedia.org',
  },
  suttacentral: {
    name: 'SuttaCentral',
    license: 'CC-BY / CC0',
    attributionText: 'Buddhist texts from SuttaCentral.net. Translations by Bhikkhu Sujato are CC0 (Public Domain).',
    url: 'https://suttacentral.net',
  },
  sefaria: {
    name: 'Sefaria',
    license: 'CC-BY / CC0',
    attributionText: 'Jewish texts from Sefaria.org. Community translations are public domain.',
    url: 'https://sefaria.org',
  },
  eurlex: {
    name: 'EUR-Lex',
    license: 'EU Reuse Policy',
    attributionText: 'Legal documents from EUR-Lex, the official website of European Union law.',
    url: 'https://eur-lex.europa.eu',
  },
};

/**
 * Component to display credits in the editor footer
 */
interface CreditsDisplayProps {
  credits: ProjectCredits;
  className?: string;
}

export function CreditsDisplay({ credits, className }: CreditsDisplayProps) {
  if (!credits.sources.length) return null;
  
  return (
    <div className={className}>
      <h3 className="text-sm font-bold mb-2">Attribution Required</h3>
      <div className="space-y-2">
        {credits.sources.map((source, i) => (
          <div key={i} className="text-xs text-muted-foreground">
            <span className="font-medium">{source.name}</span>
            {' â€¢ '}
            <span>{source.license}</span>
            {source.url && (
              <>
                {' â€¢ '}
                <a 
                  href={source.url} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="text-primary hover:underline"
                >
                  View source
                </a>
              </>
            )}
          </div>
        ))}
      </div>
      <p className="text-[10px] text-muted-foreground/60 mt-2">
        A Credits page has been added to this project.
      </p>
    </div>
  );
}
